# 系统V2版本变更说明

## 主要变更

### 1. 架构简化
- **旧版本**：使用3个路由服务器（服务器1、2、3）
- **新版本**：仅使用2个路由服务器（服务器2、3）
- **原因**：简化架构，专注于校园网环境

### 2. 动态IP地址分配
- **旧版本**：预配置固定IP地址
- **新版本**：网络控制器动态分配私网子网
- **特性**：
  - 支持10,000+网络接入端
  - 每个接入端分配/24 IPv4子网和/64 IPv6子网
  - 断线重连后恢复之前的子网分配
  - 长时间断线后自动释放资源

### 3. 初始化流程重构
- **旧版本**：简单的隧道建立和连接
- **新版本**：9步骤初始化流程
  1. DNS发现负载均衡器（sinet.top）
  2. 获取主备路由服务器信息
  3. 建立双隧道（主备）
  4. 请求IP地址分配
  5. 配置TUN接口
  6. 通告路由信息
  7. 路由服务器间交换路由
  8. 开始业务数据传输
  9. 持续监控和切换

### 4. 分布式路由协议
- **旧版本**：静态路由配置
- **新版本**：路由服务器间自动交换路由信息
- **特性**：
  - 自动学习网络接入端路由
  - 路由服务器间同步路由表
  - 支持大规模扩展（100+路由服务器）

### 5. 主备路由机制
- **旧版本**：负载均衡器推荐单个最优路由服务器
- **新版本**：负载均衡器同时返回主备路由服务器
- **特性**：
  - 主隧道传输业务数据
  - 备隧道保持连接但不传输数据
  - 根据负载均衡器决策自动切换
  - 毫秒级切换延迟

### 6. 资源生命周期管理
- **旧版本**：无自动资源清理
- **新版本**：完整的资源生命周期管理
- **特性**：
  - 检测隧道断连并释放资源
  - 支持网络接入端重连
  - 长时间断线后释放所有资源
  - 支持动态IP地址变化

## 文件变更

### 新增文件
- `common/control_protocol.py` - 控制协议模块（IP分配、路由通告）
- `network_access_endpoint/endpoint_v2.py` - 新版网络接入端实现
- `README_V2.md` - 新版部署指南
- `CHANGES_V2.md` - 本变更说明文档

### 修改文件
- `common/tunnel_protocol.py` - 新增4种消息类型
- `network_controller/controller.py` - 新增子网分配系统
- `load_balancer/server.py` - 新增主备路由选择
- `routing_server/server.py` - 新增代理和分布式路由
- `configs/network_controller.yaml` - 新增子网分配配置

### 删除配置
- `configs/routing_server_1.yaml` - 不再使用路由服务器1

## 部署变更

### 部署顺序
1. 网络控制器（新增必须先启动）
2. 负载均衡器
3. 路由服务器2、3（不再使用服务器1）
4. 网络接入端（使用endpoint_v2.py）

### 配置变更
- 网络控制器需要配置子网分配参数
- 路由服务器需要配置网络控制器URL
- 路由服务器需要配置对等路由服务器列表
- 网络接入端需要配置负载均衡器域名

## 兼容性说明

**不兼容旧版本**：V2版本与V1版本不兼容，需要完全重新部署。

主要不兼容点：
- 初始化流程完全不同
- 消息协议新增类型
- 配置文件格式变化
- 网络控制器为必需组件

## 升级建议

如果从V1升级到V2：
1. 停止所有V1组件
2. 备份配置文件
3. 按照README_V2.md重新部署
4. 更新所有配置文件
5. 按顺序启动所有组件

## 性能改进

- **子网分配容量**：从254个接入端提升到65,536个
- **扩展性**：支持100+路由服务器（通过分布式协议）
- **可靠性**：断线重连后恢复之前的配置
- **灵活性**：支持动态IP地址变化

## 已知限制

1. **路由服务器数量**：当前仅支持2个（服务器2、3）
2. **子网大小**：固定为/24（IPv4）和/64（IPv6）
3. **认证机制**：仅支持预共享密钥（PSK）
4. **DNS发现**：需要手动配置域名解析

## 后续计划

- 支持更多路由服务器（3+）
- 可配置的子网大小
- 增强的认证机制（证书、OAuth）
- 自动DNS发现和注册
- Web管理界面
- 实时监控和告警
